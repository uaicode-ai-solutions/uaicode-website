
# Plano: Adicionar Coluna business_plan_section

## Objetivo

Adicionar uma única coluna JSONB `business_plan_section` na tabela `tb_pms_reports` para armazenar toda a saída do Business Plan Parser.

---

## Estrutura da Coluna

A coluna receberá o JSON completo do parser:

```json
{
  "title": "Business Plan: Metrixa",
  "subtitle": "Strong demand and unit economics...",
  "generated_at": "2026-01-31",
  "viability_score": 70,
  "viability_label": "Promising",
  "markdown_content": "# Metrixa\n\n...",
  "charts_data": {
    "market_sizing": { "tam": "$102.98B", "sam": "$8.47B", "som": "$3.76M" },
    "financial_projections": { ... },
    "competitor_pricing": [ ... ],
    "investment_breakdown": [ ... ]
  },
  "word_count": 2850
}
```

---

## Migration SQL

```sql
-- Add business_plan_section column to tb_pms_reports
ALTER TABLE public.tb_pms_reports
ADD COLUMN IF NOT EXISTS business_plan_section jsonb DEFAULT '{}'::jsonb;

-- Add comment for documentation
COMMENT ON COLUMN public.tb_pms_reports.business_plan_section IS 
'Complete Business Plan document containing: title, subtitle, viability_score, viability_label, markdown_content, charts_data, word_count. Generated by n8n Business Plan AI pipeline.';
```

---

## Verificação Pós-Migration

Após executar a migration, a tabela terá 17 colunas, sendo a nova:

| Coluna | Tipo | Default | Descrição |
|--------|------|---------|-----------|
| `business_plan_section` | `jsonb` | `'{}'::jsonb` | Business Plan completo |

---

## Atualização n8n (Nó Supabase Update)

O nó final do n8n deverá mapear a saída do Parser diretamente:

```text
Table: tb_pms_reports
Filter: wizard_id = {{ $json._wizard_id }}
Update Column: business_plan_section = {{ $json }}
```

Onde `$json` é a saída completa do Parser (título, markdown, charts_data, etc.)

---

## Acesso no Frontend

O componente React buscará os dados via `useReportContext()`:

```typescript
// No componente BusinessPlanDocument.tsx
const { reportData } = useReportContext();
const businessPlan = reportData?.business_plan_section;

// Acesso direto aos campos
const title = businessPlan?.title;
const markdown = businessPlan?.markdown_content;
const chartsData = businessPlan?.charts_data;
const viabilityScore = businessPlan?.viability_score;
```

---

## Resumo

| Item | Valor |
|------|-------|
| Tabela | `tb_pms_reports` |
| Nova Coluna | `business_plan_section` |
| Tipo | `JSONB` |
| Default | `'{}'::jsonb` |
| Nullable | `YES` |

Ao aprovar, executarei a migration SQL para criar a coluna.
